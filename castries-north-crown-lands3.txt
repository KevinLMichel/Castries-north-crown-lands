<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crown Lands, Castries North</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      /* Saint Lucia flag inspired */
      --sl-blue: #00a3e0;
      --sl-yellow: #fcd116;
      --sl-black: #111111;
      --sl-white: #ffffff;

      --bg-body: #f5f8fb;
      --bg-card: #ffffff;
      --border-soft: #dde3ec;
      --text-main: #1b2c3b;
      --text-soft: #4f6475;
      --highlight: #00a3e0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
    }

    header {
      background: linear-gradient(
        to right,
        var(--sl-blue),
        #32b5ff,
        var(--sl-blue)
      );
      color: var(--sl-white);
      padding: 1rem 1.25rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header .title-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .badge-pill {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 999px;
      padding: 0.1rem 0.4rem;
      font-size: 0.7rem;
    }

    main {
      padding: 0.75rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Layout */

    .layout {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    @media (min-width: 900px) {
      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
        gap: 0.75rem;
        align-items: stretch;
      }
    }

    .panel {
      background: var(--bg-card);
      border-radius: 0.8rem;
      padding: 0.75rem 0.9rem;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .panel-header h2 {
      font-size: 1rem;
      margin: 0;
    }

    .panel-header small {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    /* Controls */

    .controls {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    @media (min-width: 600px) {
      .controls {
        grid-template-columns: 1.1fr 1.2fr 0.9fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .field label {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    select,
    input[type="text"] {
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-soft);
      font-size: 0.85rem;
      outline: none;
      background: #fdfefe;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: var(--highlight);
      box-shadow: 0 0 0 2px rgba(0, 163, 224, 0.15);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-bottom: 0.45rem;
    }

    .pill {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: #f3f7fb;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .pill span {
      font-weight: 600;
      color: var(--highlight);
    }

    /* Parcel list */

    .parcel-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      overflow-y: auto;
    }

    .parcel-card {
      border-radius: 0.6rem;
      border: 1px solid var(--border-soft);
      padding: 0.5rem 0.6rem;
      background: var(--bg-card);
      cursor: pointer;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 0.35rem;
      align-items: center;
      transition: border 0.12s ease, box-shadow 0.12s ease,
        transform 0.06s ease;
    }

    .parcel-card:hover {
      border-color: rgba(0, 163, 224, 0.5);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      transform: translateY(-1px);
    }

    .parcel-card.selected {
      border-color: var(--highlight);
      box-shadow: 0 0 0 2px rgba(0, 163, 224, 0.18);
      background: #f0f8ff;
    }

    .parcel-main {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .parcel-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .parcel-meta {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .parcel-tags {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.2rem;
      font-size: 0.68rem;
    }

    .tag {
      border-radius: 999px;
      padding: 0.05rem 0.35rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #f7fafc;
    }

    .tag-yellow {
      background: var(--sl-yellow);
      border-color: var(--sl-yellow);
      color: var(--sl-black);
      font-weight: 600;
    }

    .parcel-actions {
      text-align: right;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .parcel-actions button {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      cursor: pointer;
      background: var(--sl-blue);
      color: var(--sl-white);
    }

    .parcel-actions button.secondary {
      background: var(--sl-white);
      border: 1px solid var(--sl-blue);
      color: var(--sl-blue);
      margin-right: 0.25rem;
    }

    .empty-message {
      font-size: 0.8rem;
      color: var(--text-soft);
      padding: 0.5rem 0.25rem 0.3rem;
    }

    /* Details panel */

    .details {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--border-soft);
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .details h3 {
      margin: 0 0 0.3rem;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.25rem 0.7rem;
      margin-bottom: 0.4rem;
    }

    .details-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
    }

    .details-value {
      font-size: 0.8rem;
    }

    .details-note {
      font-size: 0.75rem;
      line-height: 1.4;
      background: #f3f7fb;
      border-radius: 0.5rem;
      padding: 0.4rem 0.5rem;
    }

    /* Map */

    #map {
      width: 100%;
      height: 340px;
      border-radius: 0.8rem;
      border: 1px solid var(--border-soft);
      overflow: hidden;
    }

    @media (min-width: 900px) {
      #map {
        height: 520px;
      }
    }

    /* Small helper text */

    .helper-text {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 0.3rem;
    }
  </style>
</head>

<body>
  <header>
    <div class="title-row">
      <div>
        <h1>Crown Lands, Castries North</h1>
        <p>
          La Clery, Bisee and Cedars, Crown owned parcels listed for public
          awareness in Castries North.
        </p>
      </div>
      <div class="badge">
        <span class="badge-pill">CROWN</span>
        <span>Castries North</span>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- LEFT: parcel list and controls -->
      <section class="panel">
        <div class="panel-header">
          <h2>Parcels</h2>
          <small id="parcel-count-label"></small>
        </div>

        <div class="controls">
          <div class="field">
            <label for="community-select">Community</label>
            <select id="community-select">
              <option value="All">All communities</option>
              <option value="La Clery">La Clery</option>
              <option value="Bisee">Bisee</option>
              <option value="Cedars">Cedars</option>
            </select>
          </div>

          <div class="field">
            <label for="search-input">Search block or parcel</label>
            <input
              id="search-input"
              type="text"
              placeholder="Example: 1049B, 1123, 0848F"
            />
          </div>

          <div class="field">
            <label for="sort-select">Sort</label>
            <select id="sort-select">
              <option value="community-asc">Community, then block</option>
              <option value="block-asc">Block, then parcel</option>
              <option value="parcel-asc">Parcel number</option>
            </select>
          </div>
        </div>

        <div class="pill-row">
          <div class="pill">
            Communities:
            <span>La Clery, Bisee, Cedars</span>
          </div>
          <div class="pill">
            Ownership:
            <span>Crown</span>
          </div>
        </div>

        <ul id="parcel-list" class="parcel-list"></ul>

        <div class="details" id="details-panel">
          <h3>Tap a parcel to see details</h3>
          <div class="details-note">
            You can filter by community or search for a block and parcel
            number combination. For example,
            <strong>1049B 1123</strong> for La Clery or
            <strong>1050B 155</strong> for Bisee.
          </div>
        </div>
      </section>

      <!-- RIGHT: map -->
      <section class="panel">
        <div class="panel-header">
          <h2>Map</h2>
          <small>Approximate community locations in Castries North</small>
        </div>
        <div id="map"></div>
        <p class="helper-text">
          Each marker shows the centre of La Clery, Bisee or Cedars. Parcel
          points are grouped by community in this prototype. A future
          version can place each parcel at its exact boundary.
        </p>
      </section>
    </div>
  </main>

  <!-- Load full parcel data (Castries North, all 197 rows) -->
  <script src="castries_north_crown_lands_parcels_UPDATED.js"></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Community coordinates (approximate centres)
    const COMMUNITY_COORDS = {
      "La Clery": {
        lat: 14.0185,
        lng: -60.9842,
        label: "La Clery",
      },
      Bisee: {
        lat: 14.0243,
        lng: -60.9745,
        label: "Bisee",
      },
      Cedars: {
        lat: 14.006,
        lng: -60.9823,
        label: "Cedars",
      },
    };

    // UI state
    let state = {
      community: "All",
      search: "",
      sort: "community-asc",
      selectedKey: null, // "community|block|parcel"
    };

    function makeKey(p) {
      return `${p.community}|${p.block}|${p.parcel}`;
    }

    function filterParcels() {
      const community = state.community;
      const search = state.search.trim().toLowerCase();

      let list = PARCELS.slice();

      if (community !== "All") {
        list = list.filter((p) => p.community === community);
      }

      if (search) {
        list = list.filter((p) => {
          const haystack = `${p.community} ${p.block} ${p.parcel}`
            .toLowerCase()
            .replace(/\s+/g, " ");
          return haystack.includes(search);
        });
      }

      switch (state.sort) {
        case "block-asc":
          list.sort((a, b) => {
            if (a.block === b.block) {
              return a.parcel.localeCompare(b.parcel, undefined, {
                numeric: true,
              });
            }
            return a.block.localeCompare(b.block, undefined, {
              numeric: true,
            });
          });
          break;
        case "parcel-asc":
          list.sort((a, b) =>
            a.parcel.localeCompare(b.parcel, undefined, { numeric: true })
          );
          break;
        case "community-asc":
        default:
          list.sort((a, b) => {
            if (a.community === b.community) {
              if (a.block === b.block) {
                return a.parcel.localeCompare(b.parcel, undefined, {
                  numeric: true,
                });
              }
              return a.block.localeCompare(b.block, undefined, {
                numeric: true,
              });
            }
            return a.community.localeCompare(b.community);
          });
      }

      return list;
    }

    // DOM references

    const communitySelect = document.getElementById("community-select");
    const searchInput = document.getElementById("search-input");
    const sortSelect = document.getElementById("sort-select");
    const parcelListEl = document.getElementById("parcel-list");
    const detailsPanel = document.getElementById("details-panel");
    const parcelCountLabel = document.getElementById("parcel-count-label");

    // Map setup

    const map = L.map("map", {
      scrollWheelZoom: true,
      attributionControl: true,
    });

    const mapCenter = [14.015, -60.98];
    map.setView(mapCenter, 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    const communityMarkers = {};

    Object.entries(COMMUNITY_COORDS).forEach(([key, info]) => {
      const marker = L.marker([info.lat, info.lng]).addTo(map);
      marker.bindPopup(`<strong>${info.label}</strong><br />Castries North`);
      communityMarkers[key] = marker;
    });

    function focusCommunity(community) {
      if (community && community !== "All") {
        const info = COMMUNITY_COORDS[community];
        if (info) {
          map.setView([info.lat, info.lng], 15);
          const marker = communityMarkers[community];
          if (marker) {
            marker.openPopup();
          }
        }
      } else {
        map.setView(mapCenter, 13);
      }
    }

    // Rendering

    function renderParcelList() {
      const parcels = filterParcels();
      parcelListEl.innerHTML = "";

      const total = PARCELS.length;
      const shown = parcels.length;

      parcelCountLabel.textContent = `${shown} of ${total} parcels shown`;

      if (!parcels.length) {
        parcelListEl.innerHTML =
          '<li class="empty-message">No parcels match the current filters.</li>';
        return;
      }

      parcels.forEach((p) => {
        const key = makeKey(p);
        const li = document.createElement("li");
        li.className = "parcel-card";
        if (key === state.selectedKey) {
          li.classList.add("selected");
        }

        li.innerHTML = `
          <div class="parcel-main">
            <div class="parcel-title">${p.block} ${p.parcel}</div>
            <div class="parcel-meta">
              ${p.community} &middot; ${p.district}
            </div>
            <div class="parcel-tags">
              <span class="tag tag-yellow">${p.ownership}</span>
              <span class="tag">Block ${p.block}</span>
              <span class="tag">${p.community}</span>
            </div>
          </div>
          <div class="parcel-actions">
            <button class="secondary" type="button">Details</button>
            <button type="button">Locate</button>
          </div>
        `;

        li.addEventListener("click", () => {
          state.selectedKey = key;
          renderParcelList();
          renderDetails(p);
          focusCommunity(p.community);
        });

        parcelListEl.appendChild(li);
      });
    }

    function renderDetails(parcel) {
      if (!parcel) {
        detailsPanel.innerHTML = `
          <h3>Tap a parcel to see details</h3>
          <div class="details-note">
            You can filter by community or search for a block and parcel
            number combination.
          </div>
        `;
        return;
      }

      detailsPanel.innerHTML = `
        <h3>${parcel.block} ${parcel.parcel}</h3>
        <div class="details-grid">
          <div>
            <div class="details-label">Community</div>
            <div class="details-value">${parcel.community}</div>
          </div>
          <div>
            <div class="details-label">District</div>
            <div class="details-value">${parcel.district}</div>
          </div>
          <div>
            <div class="details-label">Ownership</div>
            <div class="details-value">${parcel.ownership}</div>
          </div>
          <div>
            <div class="details-label">Block</div>
            <div class="details-value">${parcel.block}</div>
          </div>
        </div>
        <div class="details-note">
          This parcel is recorded as Crown land in Castries North.
          For official confirmation, valuation or applications, residents
          should contact the responsible government department using the
          official land registry references for block and parcel.
        </div>
      `;
    }

    // Event handlers

    communitySelect.addEventListener("change", (e) => {
      state.community = e.target.value;
      focusCommunity(state.community);
      renderParcelList();
      renderDetails(
        state.selectedKey
          ? filterParcels().find((p) => makeKey(p) === state.selectedKey)
          : null
      );
    });

    searchInput.addEventListener("input", (e) => {
      state.search = e.target.value;
      renderParcelList();
      renderDetails(
        state.selectedKey
          ? filterParcels().find((p) => makeKey(p) === state.selectedKey)
          : null
      );
    });

    sortSelect.addEventListener("change", (e) => {
      state.sort = e.target.value;
      renderParcelList();
      renderDetails(
        state.selectedKey
          ? filterParcels().find((p) => makeKey(p) === state.selectedKey)
          : null
      );
    });

    // Initial render
    renderParcelList();
    renderDetails(null);
  </script>
</body>
</html>
